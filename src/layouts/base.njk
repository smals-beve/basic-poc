<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{ title }} | {{ site.name }}</title>
    <meta name="description" content="{{ site.description }}">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="{{ site.url }}{{ page.url }}">
    <link rel="stylesheet" href="{{ '/assets/css/bootstrap.min.css' | url }}">
    <link rel="stylesheet" href="{{ '/assets/styles.css' | url }}">

    {% set pageUrl = page and page.url or '' %}
    {% set cleanUrl = pageUrl | replace('/index.html','/') %}
    {% set isApi = '/api/' in cleanUrl %}

    {# ---- One reliable language for this page ---- #}
    {% set currentLang = lang or site.defaultLang or 'en' %}
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ ('/' ~ currentLang ~ '/') | url }}">{{ site.name }}</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">
            <ul class="navbar-nav ms-auto align-items-center">
                <li class="nav-item">
                    <a class="nav-link" href="{{ ('/' ~ currentLang ~ '/') | url }}">
                        {{ 'home' | translate(currentLang) }}
                    </a>
                </li>

                {# Hide API Overview when already on any /api/* page #}
                {% if not isApi %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ ('/' ~ currentLang ~ '/api/') | url }}">
                            {{ 'api_overview' | translate(currentLang) }}
                        </a>
                    </li>
                {% endif %}

                {# Language switcher (visible everywhere). Current language highlighted. #}
                {% set supported = site.supportedLangs or ['nl','fr','en'] %}
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" id="langDropdown"
                       role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        <span aria-hidden="true">üåê</span>
                        <span class="text-uppercase">{{ currentLang }}</span>
                        <span class="visually-hidden">{{ 'language' | translate(currentLang) }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="langDropdown">
                        {% for l in supported %}
                            {% if isApi %}
                                {% set target = ('/' ~ l ~ '/api/') | url %}
                            {% else %}
                                {% set target = ('/' ~ l ~ '/') | url %}
                            {% endif %}
                            <li>
                                <a class="dropdown-item d-flex justify-content-between align-items-center{% if l == currentLang %} active{% endif %}"
                                   href="{{ target }}"
                                   {% if l == currentLang %}aria-current="true"{% endif %}>
                                    <span class="text-uppercase">{{ l }}</span>
                                    {% if l == currentLang %}<span aria-hidden="true">‚úì</span>{% endif %}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row flex-nowrap">

        {# Sidebar ONLY on non-API pages #}
        {% if not isApi %}
            <aside class="col-auto p-0 sidebar-fixed bg-light">
                <div class="sidebar-scroll">
                    <div class="sidebar-body">
                        <a href="{{ ('/' ~ currentLang ~ '/') | url }}"
                           class="d-flex align-items-center pb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                            <span class="fs-5 d-none d-sm-inline">{{ 'content' | translate(currentLang) }}</span>
                        </a>
                        {# Ensure partial uses the right lang #}
                        {% set lang = currentLang %}
                        {% include "partials/sidebar-nav.njk" %}
                    </div>
                </div>
            </aside>
        {% endif %}

        <main class="{% if isApi %}col-12{% else %}col ps-3 content-flex{% endif %} py-3">

            {# ---- Breadcrumbs ---- #}
            {% if breadcrumbs and breadcrumbs.length %}
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb">
                        {% for c in breadcrumbs %}
                            <li class="breadcrumb-item{% if loop.last %} active{% endif %}"
                                {% if loop.last %}aria-current="page"{% endif %}>
                                {% if not loop.last %}
                                    <a href="{{ c.href | url }}">{{ c.title }}</a>
                                {% else %}
                                    {{ c.title }}
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ol>
                </nav>
            {% endif %}

            {# Manifest for anchor rewriting filter #}
            {% set manifests = { 'nl': manifest_nl, 'fr': manifest_fr, 'en': manifest_en } %}
            {% set manifestForLang = manifests[currentLang] %}

            {# ---- Field switcher (only on field pages) ---- #}
            {% if fieldSwitcher and fieldSwitcher.items and fieldSwitcher.items.length %}
                <div class="d-inline-flex align-items-center">
                    <label for="switch_to"
                           class="form-label mb-0 me-2">{{ 'jump_to_field' | translate(currentLang) }}</label>
                    <select id="switch_to" class="form-select form-select-sm w-auto"
                            onchange="var v=this.value; if(v){ location.href=v; }">
                        <option value="">{{ 'choose' | translate(currentLang) }}</option>
                        {% for item in fieldSwitcher.items %}
                            <option value="{{ item.hrefPath | url }}">{{ item.title }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

            {{ content
            | stripOuterHtml
            | rewriteAssetUrls
            | rewriteDocAnchors(currentLang, pathPrefix, manifestForLang)
            | safe }}
        </main>

    </div>
</div>

<footer class="text-center mt-4 mb-3">
    <small>
        &copy; {{ site.year }} {{ site.author }}
        ¬∑ <span class="text-muted">v{{ site.version }}</span>
    </small>
</footer>

<script src="{{ '/assets/js/bootstrap.bundle.min.js' | url }}"></script>
</body>
</html>
